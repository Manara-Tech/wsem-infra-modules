name: Release Automation

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

  push:
    branches:
      - main

env:
  RELEASE_FILE: release.yml
  BOT_NAME:     "github-actions[bot]"
  BOT_EMAIL:    "github-actions[bot]@users.noreply.github.com"

jobs:

  detect-bump:
    name: Detect Version Bump Type
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    permissions:
      contents: read
      pull-requests: read

    env:
      GH_TOKEN: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}

    outputs:
      bump_type:     ${{ steps.resolve.outputs.bump_type }}
      source_branch: ${{ steps.resolve.outputs.source_branch }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve source branch
        id: resolve
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            SOURCE_BRANCH="${{ github.head_ref }}"
          else
            SOURCE_BRANCH=""
            RAW=$(curl -s \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/pulls")

            echo "Raw API response: ${RAW}"

            SOURCE_BRANCH=$(echo "$RAW" | jq -r '.[0].head.ref // empty')

            if [ -n "$SOURCE_BRANCH" ]; then
              echo "Resolved source branch from PR: ${SOURCE_BRANCH}"
            else
              COMMIT_MSG=$(git log -1 --pretty=%B "${{ github.sha }}")
              PR_NUMBER=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | head -1 | tr -d '#')
              echo "Commit message (last): ${COMMIT_MSG}"
              echo "Parsed PR number: ${PR_NUMBER}"

              if [ -n "$PR_NUMBER" ]; then
                PR_JSON=$(curl -s \
                  -H "Authorization: Bearer ${GH_TOKEN}" \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}")

                SOURCE_BRANCH=$(echo "$PR_JSON" | jq -r '.head.ref // empty')

                if [ -n "$SOURCE_BRANCH" ]; then
                  echo "Resolved source branch from commit message PR #${PR_NUMBER}: ${SOURCE_BRANCH}"
                fi
              fi
            fi

            if [ -z "$SOURCE_BRANCH" ]; then
              SOURCE_BRANCH="${{ github.ref_name }}"
              echo "No PR found for commit. Using ref: ${SOURCE_BRANCH}"
            fi
          fi

          echo "source_branch=${SOURCE_BRANCH}" >> "$GITHUB_OUTPUT"

          if [[ "$SOURCE_BRANCH" == hotfix/* ]]; then
            BUMP="patch"
          elif [[ "$SOURCE_BRANCH" == feature/* ]]; then
            BUMP="minor"
          elif [[ "$SOURCE_BRANCH" == release/* ]]; then
            BUMP="major"
          else
            echo "Branch '$SOURCE_BRANCH' does not match hotfix/**, feature/**, or release/**."
            echo "Defaulting to patch bump."
            BUMP="patch"
          fi

          echo "bump_type=${BUMP}" >> "$GITHUB_OUTPUT"
          echo "Detected bump type: ${BUMP} from branch: ${SOURCE_BRANCH}" >> "$GITHUB_STEP_SUMMARY"

  preview-version:
    name: Preview Next Version (PR Only)
    runs-on: ubuntu-latest
    needs: detect-bump
    if: github.event_name == 'pull_request'

    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate branch naming convention
        run: |
          SOURCE="${{ needs.detect-bump.outputs.source_branch }}"
          if [[ "$SOURCE" != hotfix/* && "$SOURCE" != feature/* && "$SOURCE" != release/* ]]; then
            echo "::warning::Branch name '$SOURCE' does not follow the required convention."
          else
            echo "Branch name follows convention."
          fi

      - name: Calculate preview version
        id: preview
        run: |
          CURRENT=$(grep -oP '(?<=version: ").*(?=")' ${{ env.RELEASE_FILE }})
          echo "Current version: ${CURRENT}"

          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          PATCH=$(echo "$CURRENT" | cut -d. -f3)

          BUMP="${{ needs.detect-bump.outputs.bump_type }}"
          case "$BUMP" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEXT="${MAJOR}.${MINOR}.${PATCH}"
          echo "next_version=${NEXT}" >> "$GITHUB_OUTPUT"
          echo "current_version=${CURRENT}" >> "$GITHUB_OUTPUT"

      - name: Post version preview comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const current = "${{ steps.preview.outputs.current_version }}";
            const next    = "${{ steps.preview.outputs.next_version }}";
            const bump    = "${{ needs.detect-bump.outputs.bump_type }}";
            const branch  = "${{ needs.detect-bump.outputs.source_branch }}";

            const body = `
            ## Release Preview

            | | Value |
            |---|---|
            | Source branch | \`${branch}\` |
            | Bump type | \`${bump}\` |
            | Current version | \`v${current}\` |
            | Next version on merge | \`v${next}\` |

            > This is a **preview only**. The actual tag and \`release.yml\` update
            > will be created automatically when this PR is merged into \`main\`.
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const existing = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('Release Preview')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner:      context.repo.owner,
                repo:       context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body,
              });
            }

      - name: Auto-label PR with bump type
        uses: actions/github-script@v7
        with:
          script: |
            const bump   = "${{ needs.detect-bump.outputs.bump_type }}";
            const label  = `bump:${bump}`;
            const colors = { major: 'e11d48', minor: 'f59e0b', patch: '22c55e' };

            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo:  context.repo.repo,
                name:  label,
                color: colors[bump],
                description: `Version bump type: ${bump}`,
              });
            } catch (_) {}

            const { data: current } = await github.rest.issues.listLabelsOnIssue({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            for (const l of current.filter(l => l.name.startsWith('bump:'))) {
              await github.rest.issues.removeLabel({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name:         l.name,
              });
            }

            await github.rest.issues.addLabels({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels:       [label],
            });

  create-release:
    name: Bump Version and Create Release Tag
    runs-on: ubuntu-latest
    needs: detect-bump
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: false

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_PAT || secrets.GITHUB_TOKEN }}

      - name: Configure bot git identity
        run: |
          git config user.name  "${{ env.BOT_NAME }}"
          git config user.email "${{ env.BOT_EMAIL }}"

      - name: Read current version from release.yml
        id: current
        run: |
          VERSION=$(grep -oP '(?<=version: ").*(?=")' ${{ env.RELEASE_FILE }})
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Current version: ${VERSION}"

      - name: Calculate new version
        id: bump
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          PATCH=$(echo "$CURRENT" | cut -d. -f3)

          BUMP="${{ needs.detect-bump.outputs.bump_type }}"
          case "$BUMP" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW="${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=${NEW}" >> "$GITHUB_OUTPUT"
          echo "New version: ${NEW} bump: ${BUMP}"

      - name: Update release.yml with new version
        run: |
          NEW="${{ steps.bump.outputs.new_version }}"
          sed -i "s/version: \".*\"/version: \"${NEW}\"/" ${{ env.RELEASE_FILE }}
          echo "release.yml updated to version ${NEW}"
          cat ${{ env.RELEASE_FILE }}

      - name: Commit and push updated release.yml
        run: |
          NEW="${{ steps.bump.outputs.new_version }}"
          git add ${{ env.RELEASE_FILE }}
          git commit -m "chore(release): bump version to v${NEW} [skip ci]"
          git push origin main

      - name: Create annotated Git tag
        run: |
          NEW="${{ steps.bump.outputs.new_version }}"
          BRANCH="${{ needs.detect-bump.outputs.source_branch }}"
          BUMP="${{ needs.detect-bump.outputs.bump_type }}"

          if git rev-parse "v${NEW}" >/dev/null 2>&1; then
            echo "Tag v${NEW} already exists, skipping."
          else
            git tag \
              --annotate "v${NEW}" \
              --message "Release v${NEW}
          Bump type : ${BUMP}
          Source    : ${BRANCH}
          Triggered : ${{ github.sha }}"

            git push origin "v${NEW}"
            echo "Tagged and pushed v${NEW}"
          fi

      - name: Write job summary
        run: |
          NEW="${{ steps.bump.outputs.new_version }}"
          OLD="${{ steps.current.outputs.version }}"
          BUMP="${{ needs.detect-bump.outputs.bump_type }}"
          BRANCH="${{ needs.detect-bump.outputs.source_branch }}"
          echo "## Release Created" >> "$GITHUB_STEP_SUMMARY"
          echo "| | |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Previous version | v${OLD} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| New version | v${NEW} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Bump type | ${BUMP} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Source branch | ${BRANCH} |" >> "$GITHUB_STEP_SUMMARY"
