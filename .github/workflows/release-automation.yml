name: Release Automation

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  TRIGGERS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

  push:
    branches:
      - main

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  SHARED ENV
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  RELEASE_FILE: release.yml          # single source of truth for current version
  BOT_NAME:     "github-actions[bot]"
  BOT_EMAIL:    "github-actions[bot]@users.noreply.github.com"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  JOBS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  JOB 1 â€” DETECT BUMP TYPE
  #  Runs on BOTH pr and push events.
  #  Centralises the branch-name â†’ bump-type
  #  logic so both jobs share identical rules.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  detect-bump:
    name: Detect Version Bump Type
    runs-on: ubuntu-latest

    # Skip if the push was made by the bot itself (prevents infinite loop)
    if: github.actor != 'github-actions[bot]'

    outputs:
      bump_type:   ${{ steps.resolve.outputs.bump_type }}
      source_branch: ${{ steps.resolve.outputs.source_branch }}

    steps:
      - name: Resolve source branch
        id: resolve
        run: |
          # On a PR event, github.head_ref is the feature/hotfix/release branch.
          # On a push-to-main (after merge), head_ref is empty, so we fall back
          # to reading the merge commit message which GitHub formats as:
          #   "Merge pull request #N from owner/branch-name"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            SOURCE_BRANCH="${{ github.head_ref }}"
          else
            # Extract branch name from the merge commit message
            SOURCE_BRANCH=$(git log -1 --pretty=%s | grep -oP '(?<=from .{1,100}/)(hotfix|feature|release)/[^ ]+' || echo "")
          fi

          echo "source_branch=${SOURCE_BRANCH}" >> "$GITHUB_OUTPUT"

          # â”€â”€ Map branch prefix â†’ bump type â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [[ "$SOURCE_BRANCH" == hotfix/* ]]; then
            BUMP="patch"
          elif [[ "$SOURCE_BRANCH" == feature/* ]]; then
            BUMP="minor"
          elif [[ "$SOURCE_BRANCH" == release/* ]]; then
            BUMP="major"
          else
            echo "âš ï¸  Branch '$SOURCE_BRANCH' does not match hotfix/**, feature/**, or release/**."
            echo "   Defaulting to patch bump."
            BUMP="patch"
          fi

          echo "bump_type=${BUMP}" >> "$GITHUB_OUTPUT"
          echo "### ğŸ” Detected bump type: \`${BUMP}\` (from branch: \`${SOURCE_BRANCH}\`)" >> "$GITHUB_STEP_SUMMARY"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  JOB 2 â€” PR PREVIEW
  #  Only runs on pull_request events.
  #  Shows contributors what version WOULD be
  #  released if this PR is merged. No changes
  #  are committed or tagged.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  preview-version:
    name: Preview Next Version (PR Only)
    runs-on: ubuntu-latest
    needs: detect-bump
    if: github.event_name == 'pull_request'

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate branch naming convention
        run: |
          SOURCE="${{ needs.detect-bump.outputs.source_branch }}"
          if [[ "$SOURCE" != hotfix/* && "$SOURCE" != feature/* && "$SOURCE" != release/* ]]; then
            echo "::warning::Branch name '$SOURCE' does not follow the required convention."
            echo "   Expected: hotfix/<name>, feature/<name>, or release/<name>"
          else
            echo "âœ… Branch name follows convention."
          fi

      - name: Calculate preview version
        id: preview
        run: |
          # Read current version from release.yml
          CURRENT=$(grep -oP '(?<=version: ").*(?=")' ${{ env.RELEASE_FILE }})
          echo "Current version: ${CURRENT}"

          # Split into parts
          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          PATCH=$(echo "$CURRENT" | cut -d. -f3)

          # Apply bump
          BUMP="${{ needs.detect-bump.outputs.bump_type }}"
          case "$BUMP" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEXT="${MAJOR}.${MINOR}.${PATCH}"
          echo "next_version=${NEXT}" >> "$GITHUB_OUTPUT"
          echo "current_version=${CURRENT}" >> "$GITHUB_OUTPUT"

      - name: Post version preview comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const current  = "${{ steps.preview.outputs.current_version }}";
            const next     = "${{ steps.preview.outputs.next_version }}";
            const bump     = "${{ needs.detect-bump.outputs.bump_type }}";
            const branch   = "${{ needs.detect-bump.outputs.source_branch }}";

            const body = `
            ## ğŸš€ Release Preview

            | | Value |
            |---|---|
            | ğŸŒ¿ Source branch | \`${branch}\` |
            | ğŸ“¦ Bump type | \`${bump}\` |
            | ğŸ·ï¸ Current version | \`v${current}\` |
            | âœ¨ Next version on merge | \`v${next}\` |

            > This is a **preview only**. The actual tag and \`release.yml\` update
            > will be created automatically when this PR is merged into \`main\`.
            `;

            // Find and update existing preview comment, or create a new one
            const { data: comments } = await github.rest.issues.listComments({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const existing = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('Release Preview')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner:      context.repo.owner,
                repo:       context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body,
              });
            }

      - name: Auto-label PR with bump type
        uses: actions/github-script@v7
        with:
          script: |
            const bump  = "${{ needs.detect-bump.outputs.bump_type }}";
            const label = `bump:${bump}`;
            const colors = { major: 'e11d48', minor: 'f59e0b', patch: '22c55e' };

            // Ensure label exists
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo:  context.repo.repo,
                name:  label,
                color: colors[bump],
                description: `Version bump type: ${bump}`,
              });
            } catch (_) { /* label already exists */ }

            // Remove any stale bump labels first
            const { data: current } = await github.rest.issues.listLabelsOnIssue({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });
            for (const l of current.filter(l => l.name.startsWith('bump:'))) {
              await github.rest.issues.removeLabel({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name:         l.name,
              });
            }

            await github.rest.issues.addLabels({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels:       [label],
            });

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  JOB 3 â€” ACTUAL RELEASE
  #  Only runs on push to main (after merge).
  #  Reads release.yml, bumps version, commits,
  #  pushes, and creates the annotated Git tag.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-release:
    name: Bump Version & Create Release Tag
    runs-on: ubuntu-latest
    needs: detect-bump
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write   # needed to push commits and create tags

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0          # full history needed for git log branch detection
          token: ${{ secrets.RELEASE_PAT }}

      - name: Configure bot git identity
        run: |
          git config user.name  "${{ env.BOT_NAME }}"
          git config user.email "${{ env.BOT_EMAIL }}"

      - name: Read current version from release.yml
        id: current
        run: |
          VERSION=$(grep -oP '(?<=version: ").*(?=")' ${{ env.RELEASE_FILE }})
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "ğŸ“– Current version: ${VERSION}"

      - name: Calculate new version
        id: bump
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          PATCH=$(echo "$CURRENT" | cut -d. -f3)

          BUMP="${{ needs.detect-bump.outputs.bump_type }}"
          case "$BUMP" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW="${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=${NEW}" >> "$GITHUB_OUTPUT"
          echo "ğŸ†• New version: ${NEW} (bump: ${BUMP})"

      - name: Update release.yml with new version
        run: |
          NEW="${{ steps.bump.outputs.new_version }}"
          # Overwrite the version field in release.yml
          sed -i "s/version: \".*\"/version: \"${NEW}\"/" ${{ env.RELEASE_FILE }}
          echo "âœ… release.yml updated to version ${NEW}"
          cat ${{ env.RELEASE_FILE }}

      - name: Commit and push updated release.yml
        run: |
          NEW="${{ steps.bump.outputs.new_version }}"
          git add ${{ env.RELEASE_FILE }}
          git commit -m "chore(release): bump version to v${NEW} [skip ci]"
          git push origin main

      - name: Create annotated Git tag
        run: |
          NEW="${{ steps.bump.outputs.new_version }}"
          BRANCH="${{ needs.detect-bump.outputs.source_branch }}"
          BUMP="${{ needs.detect-bump.outputs.bump_type }}"

          git tag \
            --annotate "v${NEW}" \
            --message "Release v${NEW}

          Bump type : ${BUMP}
          Source    : ${BRANCH}
          Triggered : ${{ github.sha }}"

          git push origin "v${NEW}"
          echo "ğŸ·ï¸  Tagged and pushed v${NEW}"

      - name: Write job summary
        run: |
          NEW="${{ steps.bump.outputs.new_version }}"
          OLD="${{ steps.current.outputs.version }}"
          BUMP="${{ needs.detect-bump.outputs.bump_type }}"
          BRANCH="${{ needs.detect-bump.outputs.source_branch }}"
          echo "## âœ… Release Created" >> "$GITHUB_STEP_SUMMARY"
          echo "| | |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Previous version | \`v${OLD}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| New version | \`v${NEW}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Bump type | \`${BUMP}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Source branch | \`${BRANCH}\` |" >> "$GITHUB_STEP_SUMMARY"